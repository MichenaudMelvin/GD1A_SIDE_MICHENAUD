<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser Side Scroller</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
			display: flex;
			justify-content: center;
		}
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1280,
    height: 720,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: {y: 300},
            debug: true,
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};


var player;
var speedLaser;
var platforms;
var cursors;
var gameOver = false;

var game = new Phaser.Game(config);
var frame = 0;

//variables qui permette le jetpack
var text;
var jetpackValue = 100;
var jetpackValueTxt = "";
var ableToUseJet = false;
var checkUpisUp = false;
var startJetPackDone = false;
var frameCheckOnce = false;


//variables pour ennmis :
var timerEnnemi = 0;
var deplacementEnnemi;
var alreadyShuffle = false;
var frameDePause1;
var frameDePause2;
var keyA;

function preload (){
    this.load.image('test', 'assets/testItem.png');
    this.load.image('background', 'assets/fond.png');
    this.load.image('ground', 'fichier_de_travail/sideScrollerFichierDeTravail-assets/foreground.png');
    this.load.image('coeur', 'assets/coeur.png');
    this.load.image('coeurVide', 'assets/coeurVide.png');
    this.load.image('laser', 'assets/laser.png');
    this.load.spritesheet('dude', 'assets/dude.png', {frameWidth: 32, frameHeight: 48});
}

function create (){
    this.background = this.add.image(0, 0, 'background');
    this.background.setOrigin(0, 0);

    laser = this.add.sprite(100, 500, 'laser');
    var ennemiTween = this.tweens.add({
        targets: laser,
        x: 1920,
        duration: 960,
        yoyo: false,
        repeat: -1,
    });

    platforms = this.physics.add.staticGroup();
    vie = this.physics.add.staticGroup();

    platforms.create(640, 675, 'ground'); //sol
    vie.create(10, 10, 'coeur');
    vie.create(30, 10, 'coeur');
    vie.create(50, 10, 'coeur');

    player = this.physics.add.sprite(100, 600, 'dude');
    testOppo = this.physics.add.sprite(300, 600, 'test');

    player.setBounce(0.5);
    player.setCollideWorldBounds(true);
    testOppo.setCollideWorldBounds(true);
    
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', {start: 0, end: 3}),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [{key: 'dude', frame: 4}],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', {start: 5, end: 8}),
        frameRate: 10,
        repeat: -1
    });
    
    cursors = this.input.keyboard.createCursorKeys();
    keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A)

    //gestion des collisions
    this.physics.add.collider(player, platforms, colliderPlatformPlayer);
    // this.physics.add.collider(laser, platforms, laserCollider);
    this.physics.add.overlap(player, ennemiTween, hitPlayer, null, this);
    this.physics.add.collider(testOppo, platforms);
    this.physics.add.collider(player, testOppo);
    //quand powerUp est touchÃ©
    // this.physics.add.overlap(player, powerUp, powerUpFunction);

    //regarder le logiciel tiled
    
    this.cameras.main.startFollow(player);
}

function update (){
    frame = frame + 1;
    if(frame == 70){
        frame = 0
    }

    if (gameOver){
        return;
    }

    if (cursors.left.isDown){
        player.setVelocityX(-160);

        player.anims.play('left', true);
    } else if (cursors.right.isDown){
        player.setVelocityX(160);

        player.anims.play('right', true);
    } else{
        player.setVelocityX(0);

        player.anims.play('turn');
    }

    //saut + jetpack
    if (player.body.touching.down && cursors.up.isDown){
        player.setVelocityY(-330);
        ableToUseJet = true;
    }

    if (!player.body.touching.down && cursors.up.isUp && ableToUseJet == true && jetpackValue > 0){
        checkUpisUp = true;
    } if (cursors.up.isDown && checkUpisUp == true && ableToUseJet == true && jetpackValue > 0){
        jetpackValue = jetpackValue - 1
        if(startJetPackDone == true){
            for(let i = 0; i < 1000; i ++){
                console.log(2*i)
                player.setVelocityY(-1*i);
                startJetPackDone = true;
            }
        
        } else{
            player.setVelocityY(-300);
        } if (jetpackValue < 0){
            jetpackValue = 0;
        }
    }
    
    if(cursors.up.isUp && checkUpisUp == true && ableToUseJet == true){
        startJetPackDone = false;
        frameCheckOnce = false;
    }

    if(jetpackValue < 100){
        if(player.x < 100){
            xJetText = 100;
        } else{
            xJetText = -100;
        }
        //make this shit disappear
        text = this.add.text(player.x+xJetText, player.y, jetpackValue);
        if(frameCheckOnce == false){
            var frameCheck = frame+10
            frameCheckOnce = true;
        }
        while(frame <= frameCheck){
            text.destroy();
            frame = frame+1;
        }
    }

    timerEnnemi = timerEnnemi + 1;
    //comportement de l'ennemi
    //working but look at acceleration
    if(timerEnnemi >= 0 && timerEnnemi < 100){
        if(alreadyShuffle == false){
            frameDePause1 = chiffreAleatoire(10, 250);
            frameDePause2 = chiffreAleatoire(10, 250);
            deplacementEnnemi = (-chiffreAleatoire(100, 300));
            alreadyShuffle = true;
        } testOppo.setVelocityX(deplacementEnnemi);
    } else if (timerEnnemi > 100 && timerEnnemi < frameDePause1){
        alreadyShuffle = false;
        testOppo.setVelocityX(0);
    } else if (timerEnnemi > frameDePause1 && timerEnnemi < (frameDePause1+frameDePause2)){
        if(alreadyShuffle == false){
            deplacementEnnemi = chiffreAleatoire(100, 300);
            alreadyShuffle = true;
        } testOppo.setVelocityX(deplacementEnnemi);
    } else if (timerEnnemi > (frameDePause1+frameDePause2) && timerEnnemi < (frameDePause1+frameDePause2+((frameDePause1+frameDePause2)/2))){
        alreadyShuffle = false;
        testOppo.setVelocityX(0);
    } else if (timerEnnemi >= (frameDePause1+frameDePause2+((frameDePause1+frameDePause2)/2))){
        timerEnnemi = 0;
    }

    //permetra le tri de l'ennemi
    // if(player.y+10 >= testOppo.y && player.y-10 <= testOppo.y){
    //     
    // }

    if (keyA.isDown){
        player.setVelocityX(330)
        var ennemiTween = this.tweens.add({
            targets: laser,
            x: 1280,
            duration: 960,
            yoyo: false,
            repeat: -1,
        });
    }
    // function avanceEnnemi (ennemiTween, target){
    //     target.toggleFlipX().setAlpha(0.2 + Math.random());
    // }
}

//pour le reset du jetPack
function colliderPlatformPlayer(){
    checkUpisUp = false;
    ableToUseJet = false;
    for (let i = 0; i < 9; i++) {
        jetpackValue = jetpackValue + i;
    } if (jetpackValue > 100){
        jetpackValue = 100;
    }
}

function powerUpFunction(){
    powerUp.disableBody(true, true);
    player.setVelocityY(-1500);
}

function hitPlayer(player, ennemi, pv){
    console.log("Game over")
    if(pv != 0){
        vie.create(50, 10, 'coeurVide');
        if(pv == 3){
            vie.create(50, 10, 'coeurVide');
        // } else if(pv == 2){
        //     vie.create(30, 10, 'coeurVide');
        // } else if(pv == 1){
        //     vie.create(10, 10, 'coeurVide');
        }
        pv = pv - 1;
        console.log(pv);
    } else if(pv == 0){
        console.log("Game over")
    }
    
}

function chiffreAleatoire(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min)) + min;
}

</script>
</body>
</html>